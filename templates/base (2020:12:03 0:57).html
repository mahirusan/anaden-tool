<!DOCTYPE html>
{% load static %}
<html lang="ja">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <!-- CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" 
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
        {% block extra_css %}{% endblock %}

        <title>{% block page_title %}{% endblock %}</title>

        <script>
            // ドキュメントがリロードされた後に読み込む設定
            document.addEventListener('DOMContentLoaded',function(){
                // 初期表示の設定
                $('.menu-content').toggle();
                $('.click-menu').toggle();
                $('.fin-tasks').toggle();
                //$('.main-contents').toggleClass('click-menu-open');

                // カード一覧をカスタムデータnumを使ってidの降順に並び替える
                function sortCard(cards){
                    var sortedCards = cards.sort(function(a,b){
                        // console.log($(a).data('num'));
                        // a,bのカスタムデータを取得
                        var aNum = $(a).data('num');
                        var bNum = $(b).data('num');

                        // 昇順ソート(不等号を逆にすれば降順にもできる)
                        if(Number(aNum) > Number(bNum)){
                            return 1;
                        }else if(Number(aNum) < Number(bNum)){
                            return -1;
                        }
                        return 0;
                    });
                    // console.log(sortedCard);
                    return sortedCards;
                }
                
                // メニューボタンのクリックイベント
                $('.menu-btn').click(function(){
                    $('.menu-content').stop(true).toggle('fast');
                    $('.click-menu').stop(true).animate({'width':'toggle'});
                    $('.main-contents').stop(true).toggleClass('click-menu-open');
                });

                // 完了済タスクを見るボタンのクリックイベント
                $('.fintask-btn').click(function(){
                    var $this = $(this);
                    var pare = $this.parent();
                    pare.siblings('.fin-tasks').slideToggle();
                });


                
                // $('.success_btn').click(function(){
                //     console.log("success-btnがクリックされました");
                //     var $this = $(this);
                //     var taskId = $this.data('taskid');
                //     var condition = $this.data('condition');
                //     var card = $this.parents('.card.task-contents');
                //     var finTasks = card.parents('.card-body').children('.fin-tasks');
                //     var newTasks = card.parents('.card-body').children('.new-tasks');
                //     $.ajax({
                //         type:"get",
                //         url:"{% url 'app:condition_change' %}",
                //         dataType:"json",
                //         data:{
                //             "task_id":taskId,
                //             "condition":condition
                //         }
                //     })
                //     .done(function(data){
                //         console.log('Ajax Success'); //[DEBUG]
                //         $this.stop(true).toggleClass('clicked');
                //         if(condition == "1"){
                //             $this.data('condition',"3");
                //             card.parent().appendTo(finTasks);
                //             // card.siblings('.card-space').appendTo(finTasks);
                //             // 移動したタスクの並び替え
                //             // console.log(finTasks.children());//[DEBUG]
                //             var sortedFinTasks = sortCard(finTasks.children());
                //             console.log(sortedFinTasks);
                //             // console.log(finTasks.children()); //[DEBUG]
                //             finTasks.empty();
                //             sortedFinTasks.each(function(){
                //                 finTasks.append($(this));
                //             });
                //         }else if(condition == "3"){
                //             $this.data('condition',"1");
                //             card.parent().appendTo(newTasks);
                //             // card.siblings('.card-space').appendTo(newTasks);
                //             // 移動したタスクの並び替え
                //             // console.log(newTasks.children()); //[DEBUG]
                //             var sortedNewTasks = sortCard(newTasks.children());
                //             console.log(sortedNewTasks); //[DEBUG]
                //             newTasks.empty();
                //             sortedNewTasks.each(function(){
                //                 newTasks.append($(this));
                //             });
                //         }
                //         // card.slideToggle('fast');
                //     }).fail(function(msg){
                //         console.log('Ajax Error');
                //         // console.log(taskId);
                //         // console.log(condition);
                //     });
                // });

                // $('.test-btn').click(function(){
                //     var $this = $(this);
                //     var place = $this.data('place');
                //     console.log($this);
                //     console.log(place);
                //     if(place == "a"){
                //         console.log("aん飛んでます");
                //         $this.data('place',"b")
                //         $this.appendTo($('.bbb'));
                //     }else if(place == "b"){
                //         console.log("bに飛んでます");
                //         $this.data('place',"a");
                //         $this.appendTo($('.a'));
                //     }
                // });
            });

            $(document).on('click','.success_btn',function(){
                var $this = $(this);
                console.log($this[0]);
                // var taskId = $this.data('taskid');
                var condition = $this.data('condition');
                var card = $this.parents('.card.task-contents');

                // 完了ボタンのクラスの切り替え(見た目の変化)
                $this.stop(true).toggleClass('clicked');

                if(condition == "1"){
                    var finTasks = card.parents('.card-body').children('.fin-tasks');
                    // 状態変化+完了タスクリストに入れる
                    $this[0].dataset.condition = "3";
                    card.parent().appendTo(finTasks);

                    // 並び替え
                    var sortedFinTasks = sortCard(finTasks.children());
                    finTasks.empty();
                    sortedFinTasks.each(function(){
                        finTasks.append($(this));
                    });
                    console.log("完了");
                }else if(condition == "3"){
                    var newTasks = card.parents('.card-body').children('.new-tasks');
                    // 状態変化+新規タスクリストに入れる
                    $this[0].dataset.condition = "1";
                    card.parent().appendTo(newTasks);

                    // 並び替え
                    var sortedNewTasks = sortCard(newTasks.children());
                    newTasks.empty();
                    sortedNewTasks.each(function(){
                        newTasks.append($(this));
                    });
                    console.log("完了");
                }
            });
            
        </script>
      </head>

      <body>
        <header style="background-image:url({% static 'images/anaden_header.JPG' %});">
            <div class="logo" style="float:left;">
                <a href="/">
                    <div style="width:200px;height:60px;background-color:skyblue;opacity:0.5;">anaden-tool</div>
                </a>
            </div>
            <div class="menu-btn" style="float:right;">
                <a id="menu">
                    <div style="width:50px;height:60px;background-color:#eee;opacity:0.5;"></div>
                </a>
                
            </div>
            <div style="clear:both;"></div>
        </header>

        <!-- <div class="test">
            <div class="a">
                <a class="test-btn" data-place="a">osutoidou</a>
            </div>
            <div class="bbb">
    
            </div>
        </div> -->

        <div id="wrap" style="position:relative;">
            <div class="contents">
                <div class="click-menu">
                    <div class="menu-content-box pr-5"></div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#story" class="menu-link">ストーリー</a>
                    </div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#other_story" class="menu-link">外伝</a>
                    </div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#other" class="menu-link">その他</a>
                    </div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#task_management" class="menu-link">やること管理</a>
                    </div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#fishing" class="menu-link">釣り管理</a>
                    </div>
                    <div class="menu-content pr-5 pt-3">
                        <a href="#mypage" class="menu-link">マイページ</a>
                    </div>
                </div>
                <div class="main-contents">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </div>
        <footer></footer>

    
        <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
        <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" 
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
        <script src="https://code.jquery.com/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        {% block extra_js %}{% endblock %}
      </body>
</html>